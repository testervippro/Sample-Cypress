pipeline {
    agent any

    tools {
        nodejs "nodejs" // Ensure Node.js is installed and available
    }

    environment {
        HTML_REPORT_DIR = "${WORKSPACE}/cypress/reports/mochawesome-report" // Directory for Mochawesome HTML reports
        JENKINS_URL = 'https://ed1f-116-96-46-98.ngrok-free.app' // Dynamic Jenkins URL
        MOCHA_ZIP_URL = 'http://localhost:8080/job/Cypress/38/Mochawesome_20Report/*zip*/Mochawesome_20Report.zip' // URL for the Mochawesome zip report
        LOCAL_ZIP_FILE = "${WORKSPACE}/Mochawesome_Report.zip" // Local path for the downloaded zip file
    }

    stages {
        // Install project dependencies
        stage('Install Dependencies') {
            steps {
                sh 'npm ci' // Clean install dependencies
            }
        }

        stage('Create Report Directory') {
            steps {
                sh 'mkdir -p ${HTML_REPORT_DIR}'
            }
        }

        stage('Run Cypress Tests and Generate Reports') {
            steps {
                sh 'npm run cy:run-report' // Run Cypress with the updated report generation command
            }
        }

        stage('Download, Unzip, and Open Report') {
            steps {
                script {
                    // Step 1: Download the zip file
                    sh "curl -L ${env.MOCHA_ZIP_URL} -o ${env.LOCAL_ZIP_FILE}"

                    // Step 2: Unzip the file
                    sh "unzip -o ${env.LOCAL_ZIP_FILE} -d ${env.HTML_REPORT_DIR}"

                    // Step 3: Check if the report exists
                    def reportExists = fileExists("${env.HTML_REPORT_DIR}/Cypress_HTML_Report.html")
                    if (reportExists) {
                        echo "Report downloaded and unzipped at ${env.HTML_REPORT_DIR}/Cypress_HTML_Report.html"
                    } else {
                        error "HTML report not found in ${env.HTML_REPORT_DIR}"
                    }
                }
            }
        }

        // Publish HTML reports to Jenkins
        stage('Publish HTML Report') {
            steps {
                script {
                    // Check if the report exists after unzipping
                    def reportExists = fileExists("${env.HTML_REPORT_DIR}/Cypress_HTML_Report.html")
                    if (reportExists) {
                        publishHTML(target: [
                            reportName: 'Cypress Mochawesome Report',
                            reportDir: "${env.HTML_REPORT_DIR}",
                            reportFiles: 'Cypress_HTML_Report.html',
                            keepAll: true
                        ])
                    } else {
                        error "No HTML report found in ${env.HTML_REPORT_DIR}"
                    }
                }
            }
        }
    }

    // Post-build actions (always run, regardless of success or failure)
    post {
        always {
            echo 'Pipeline completed.' // Log completion message
        }

        success {
            echo 'Tests completed successfully!'
        }

        failure {
            echo 'Tests failed!'
        }
    }
}
